@using MatrixRoomUtils.Web.Shared.RoomListComponents;
@using MatrixRoomUtils.Core.StateEventTypes
@using MatrixRoomUtils.Core.StateEventTypes.Common
@using MatrixRoomUtils.Core.StateEventTypes.Spec
<p>@Rooms.Count rooms total, @RoomsWithTypes.Sum(x=>x.Value.Count) fetched so far...</p>
@if(Rooms.Count != RoomsWithTypes.Sum(x=>x.Value.Count)) {
    <p>Fetching more rooms...</p>
    @foreach (var category in RoomsWithTypes.OrderBy(x => x.Value.Count)) {
        <p>@category.Key (@category.Value.Count)</p>
    }
}
else {
    @foreach (var category in RoomsWithTypes.OrderBy(x => x.Value.Count)) {
        <RoomListCategory Category="@category" GlobalProfile="@GlobalProfile"></RoomListCategory>
    }
}

@code {

    [Parameter]
    public List<RoomInfo> Rooms { get; set; }
    [Parameter]
    public ProfileResponseEventData? GlobalProfile { get; set; }

    Dictionary<string, List<RoomInfo>> RoomsWithTypes = new();
    
    protected override async Task OnInitializedAsync() {
        GlobalProfile ??= await (await MRUStorage.GetCurrentSession())!.GetProfile((await MRUStorage.GetCurrentSession())!.WhoAmI.UserId);
        if (RoomsWithTypes.Any()) return;

        var tasks = Rooms.Select(AddRoom);
        await Task.WhenAll(tasks);

        await base.OnInitializedAsync();
    }

    private string GetRoomTypeName(string? roomType) => roomType switch {
        "m.space" => "Space",
        "msc3588.stories.stories-room" => "Story room",
        "support.feline.policy.lists.msc.v1" => "MSC3784 Policy list (v1)",
        null => "Room",
        _ => roomType
        };

    
    private static SemaphoreSlim _semaphoreSlim = new(8, 8);
    private async Task AddRoom(RoomInfo room) {
        await _semaphoreSlim.WaitAsync();
        string roomType;
        try {
            RoomCreateEventData createEvent = (await room.GetStateEvent("m.room.create")).TypedContent as RoomCreateEventData;
            roomType = GetRoomTypeName(createEvent.Type);

            if (roomType == "Room") {
                var mjolnirData = await room.GetStateEvent("org.matrix.mjolnir.shortcode");
                if(mjolnirData?.RawContent?.ToJson(ignoreNull: true) is not null and not "{}")
                    roomType = "Legacy policy room";
            }
            //prefetch some stuff
            await Task.WhenAll(
                room.GetStateEvent("m.room.name"),
                room.GetStateEvent("m.room.name")
                );
        }
        catch (MatrixException e) {
            roomType = $"Error: {e.ErrorCode}";
        }
        
        if (!RoomsWithTypes.ContainsKey(roomType)) {
            RoomsWithTypes.Add(roomType, new List<RoomInfo>());
        }
        RoomsWithTypes[roomType].Add(room);
        
        // if (RoomsWithTypes[roomType].Count % 10 == 0)
            StateHasChanged();
        // await Task.Delay(100);
        _semaphoreSlim.Release();
    }

}