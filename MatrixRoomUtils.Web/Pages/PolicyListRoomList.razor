@page "/PolicyListEditor"
@using MatrixRoomUtils.Authentication
@using MatrixRoomUtils.Web.Classes
@using Blazored.LocalStorage
@using System.Net.Http.Headers
@using System.Text.Json
@using System.Xml.Schema
@using MatrixRoomUtils.Extensions
@using MatrixRoomUtils.StateEventTypes
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
<h3>Policy list editor</h3>

<h5>Room list</h5>
<hr/>
@if (PolicyRoomList.Count == 0)
{
    <p>No policy rooms found.</p>
    <p>Loading progress: @checkedRoomCount/@totalRoomCount</p>
}
else
{
    @if (checkedRoomCount != totalRoomCount)
    {
        <p>Loading progress: @checkedRoomCount/@totalRoomCount</p>
    }
    foreach (var s in PolicyRoomList)
    {
        <a href="@(NavigationManager.Uri + "/" + s.RoomId.Replace('.', '~'))">[@s.Shortcode] @s.Name (@s.RoomId)</a>
        <br/>
    }
}

<div style="margin-bottom: 4em;"></div>
<LogView></LogView>

@code {
    //get room list
    // - sync withroom list filter
    // type = support.feline.msc3784
    //support.feline.policy.lists.msc.v1

    public List<PolicyRoomInfo> PolicyRoomList { get; set; } = new();

    private int checkedRoomCount { get; set; } = 0;
    private int totalRoomCount { get; set; } = 0;

    protected override async Task OnInitializedAsync()
    {
        if (!LocalStorageWrapper.WasLoaded) await LocalStorageWrapper.LoadFromLocalStorage(LocalStorage);
        await base.OnInitializedAsync();
        if (LocalStorageWrapper.AccessToken == null || LocalStorageWrapper.CurrentHomeserver == null)
        {
            NavigationManager.NavigateTo("/Login");
            return;
        }
        await EnumeratePolicyRooms();
        Console.WriteLine("Policy list editor initialized!");
    }

    private async Task EnumeratePolicyRooms()
    {
        var xxxrooms = await LocalStorageWrapper.CurrentHomeServer.GetJoinedRooms();
        totalRoomCount = xxxrooms.Count;
        StateHasChanged();

        var xxxsemaphore = new SemaphoreSlim(256);
        var xxxtasks = new List<Task<PolicyRoomInfo?>>();
        foreach (var room in xxxrooms)
        {
            xxxtasks.Add(GetPolicyRoomInfo(room.RoomId, xxxsemaphore));
        }
        var xxxresults = await Task.WhenAll(xxxtasks);
        PolicyRoomList.AddRange(xxxresults.Where(x => x != null).Select(x => x.Value));

        Console.WriteLine($"Detected policy lists: {PolicyRoomList.ToJson()}");
        return;
        
        using HttpClient wc = new();
        wc.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", LocalStorageWrapper.AccessToken);

        
        
    //get room list
    //temporary hack until rooms get enumerated...
        string[] rooms = { "!fTjMjIzNKEsFlUIiru:neko.dev" };
        var _rooms = await wc.GetAsync($"{LocalStorageWrapper.CurrentHomeserver}/_matrix/client/v3/joined_rooms");
        Console.WriteLine($"Got {_rooms.StatusCode}...");
        if (!_rooms.IsSuccessStatusCode)
        {
            Console.WriteLine($"Failed to get rooms: {await _rooms.Content.ReadAsStringAsync()}");
            return;
        }
        var _rooms_o = await _rooms.Content.ReadFromJsonAsync<JsonElement>();
        if (_rooms_o.TryGetProperty("joined_rooms", out JsonElement _rooms_j))
        {
            rooms = _rooms_j.EnumerateArray().Select(x => x.GetString()).ToArray();
        }

        totalRoomCount = rooms.Length;
        StateHasChanged();

        var semaphore = new SemaphoreSlim(256);
        var tasks = new List<Task<PolicyRoomInfo?>>();
        foreach (string room in rooms)
        {
            tasks.Add(GetPolicyRoomInfo(room, semaphore));
        }
        var results = await Task.WhenAll(tasks);
        PolicyRoomList.AddRange(results.Where(x => x != null).Select(x => x.Value));


    //print to console
        Console.WriteLine($"Detected policy lists: {PolicyRoomList.ToJson()}");
    }

    private async Task<PolicyRoomInfo?> GetPolicyRoomInfo(string room, SemaphoreSlim semaphore)
    {
        try
        {
            await semaphore.WaitAsync();
            PolicyRoomInfo roomInfo = new()
            {
                RoomId = room
            };
            using HttpClient wc = new();
            wc.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", LocalStorageWrapper.AccessToken);
            var sk = await wc.GetAsync($"{LocalStorageWrapper.CurrentHomeserver}/_matrix/client/v3/rooms/{room}/state/org.matrix.mjolnir.shortcode");
            if (sk.IsSuccessStatusCode)
            {
                var sko = await sk.Content.ReadFromJsonAsync<JsonElement>();
                if (sko.TryGetProperty("shortcode", out JsonElement shortcode))
                {
                    Console.WriteLine($"Room {room} has a shortcode: {shortcode.GetString()}!");
                    roomInfo.Shortcode = shortcode.GetString();
                    // sk = await wc.GetAsync($"{LocalStorageWrapper.CurrentHomeserver}/_matrix/client/v3/rooms/{room}/state/m.room.name");
                    // if (sk.IsSuccessStatusCode)
                    // {
                    //     Console.WriteLine($"Got content: {await sk.Content.ReadAsStringAsync()}");
                    //     sko = await sk.Content.ReadFromJsonAsync<JsonElement>();
                    //     if (sko.TryGetProperty("name", out JsonElement roomname))
                    //     {
                    //         Console.WriteLine($"Room {room} has a name: {roomname.GetString()}!");
                    //         roomInfo.Name = roomname.GetString();
                    //     }
                    //     else Console.WriteLine("No record found...");
                    // }
                    // else if (sk.StatusCode == System.Net.HttpStatusCode.NotFound)
                    // {
                    // }
                    // else Console.WriteLine($"Got failure while checking {room}: {sk.StatusCode} ({await sk.Content.ReadAsStringAsync()})...");
                    var r = await LocalStorageWrapper.CurrentHomeServer.GetRoom(room);
                    roomInfo.Shortcode = (await r.GetStateAsync("org.matrix.mjolnir.shortcode")).Value.GetProperty("shortcode").GetString();
                    roomInfo.Name = await r.GetNameAsync();
                    return roomInfo;
                }
                else Console.WriteLine("No record found...");
            }
            else if (sk.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
            }
            else Console.WriteLine($"Got failure while checking {room}: {sk.StatusCode} ({await sk.Content.ReadAsStringAsync()})...");
            
            return null;
        }
        finally
        {
            checkedRoomCount++;
            StateHasChanged();
            semaphore.Release();
        }
    }

    public struct PolicyRoomInfo
    {
        public string RoomId { get; set; }
        public string? Shortcode { get; set; }
        public string? Name { get; set; }
    }
    } 